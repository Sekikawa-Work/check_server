# 株式会社フィックスポイント プログラミング試験
A社の監視システムでは、監視対象となる複数台のサーバに対して一定間隔でping応答確認を行っており、確認結果は以下に示すカンマ区切りの形式で1行ずつ監視ログファイルに追記される。
<br>
`＜確認日時＞,＜サーバアドレス＞,＜応答結果＞`
<br>
確認日時は、`YYYYMMDDhhmmss`(年＝YYYY（4桁の数字）、月＝MM（2桁の数字。以下同様）、日＝DD、時＝hh、分＝mm、秒＝ss)である。
サーバアドレスは、ネットワークプレフィックス長付きのIPv4アドレスである。
応答結果には、pingの応答時間がミリ秒単位で記載される。ただし、タイムアウトした場合は"-"(ハイフン記号)となる。
<br>
本課題では、監視ログファイルはcsvとして扱い、設問1,2のテストには以下のようなlog12.csvを、設問3,4のテストにはそれぞれlog3.csv,log4.csvを使用した。使用言語はPythonであり、本試験の設問のプログラムはcheck_server.pyにメソッドごとにまとめてある。
```
20201019133024,10.20.30.1/16,1
20201019133025,10.20.30.2/16,980
20201019133034,192.168.1.1/24,43
20201019133035,192.168.1.2/24,15
20201019133124,10.20.30.1/16,2
20201019133125,10.20.30.2/16,-
20201019133134,192.168.1.1/24,10
20201019133135,192.168.1.2/24,-
20201019133224,10.20.30.1/16,522
20201019133225,10.20.30.2/16,-
20201019133234,192.168.1.1/24,8
20201019133235,192.168.1.2/24,-
20201019133324,10.20.30.1/16,-
20201019133325,10.20.30.2/16,2
20201019133334,192.168.1.1/24,105
20201019133335,192.168.1.2/24,-
20201019133424,10.20.30.1/16,88
20201019133425,10.20.30.2/16,2
20201019133434,192.168.1.1/24,8
20201019133435,192.168.1.2/24,15
```
## 設問1
上記仕様の監視ログファイルを読み込み、故障状態のサーバアドレスとそのサーバの故障期間を出力するメソッド`find_timed_out_ip(filename)`を作成した。引数は監視ログファイルの名前である。
手順は以下の通りである。

1. 読み込んだ監視ログファイルを行ごとに参照する。
2. 以前の実行でタイムアウトしていない状態で応答結果からタイムアウトが確認できた場合、確認日時とIPv4アドレスの組を記録する。
3. IPv4アドレスが記録したものと一致するかつタイムアウトしていない行が出た場合、そのIPv4アドレスおよび記録した確認日時とその行の確認日時の差分を`＜サーバアドレス＞,＜故障期間(秒)＞,＜故障時刻(YYYY-MM-DD hh:mm:ss)＞,＜復旧時刻(YYYY-MM-DD hh:mm:ss)＞`のフォーマットで出力する。

テスト用データlog12.csvを使用し、`find_timed_out_ip("./log12.csv")`で実行したときの結果は以下のようになった。
```
10.20.30.2/16,120,2020-10-19 13:31:25,2020-10-19 13:33:25
10.20.30.1/16,60,2020-10-19 13:33:24,2020-10-19 13:34:24
192.168.1.2/24,180,2020-10-19 13:31:35,2020-10-19 13:34:35
```
## 設問2
ネットワークの状態によっては、pingの応答が無い状態でも、一定時間するとpingの応答が復活することがある。そこで、N回以上連続してタイムアウトした場合にのみ故障とみなすようにメソッド`find_timed_out_ip(filename)`を拡張した。拡張したメソッド`find_timed_out_ip_N(filename, N: int)`の動作で設問1と違う点は、アドレスを記録するリストに連続でタイムアウトした回数が加えられていて2回目以降のタイムアウトで加算されること、その回数がN以上となったときにエラーとして出力されることである。

テスト用データlog12.csvを使用し、
```
    print("N=1")
    find_timed_out_ip_N("./log12.csv", 1)
    print("N=2")
    find_timed_out_ip_N("./log12.csv", 2)
    print("N=3")
    find_timed_out_ip_N("./log12.csv", 3)
```
のようにして実行したときの結果は以下のようになった。
```
N=1
10.20.30.2/16,120,2020-10-19 13:31:25,2020-10-19 13:33:25
10.20.30.1/16,60,2020-10-19 13:33:24,2020-10-19 13:34:24
192.168.1.2/24,180,2020-10-19 13:31:35,2020-10-19 13:34:35
N=2
10.20.30.2/16,120,2020-10-19 13:31:25,2020-10-19 13:33:25
192.168.1.2/24,180,2020-10-19 13:31:35,2020-10-19 13:34:35
N=3
192.168.1.2/24,180,2020-10-19 13:31:35,2020-10-19 13:34:35
```
## 設問3
直近m回の平均応答時間がtミリ秒を超えた場合のことを、サーバが過負荷状態になっていると定義する。
設問2のメソッド`find_timed_out_ip_N(filename, N: int)`を拡張して、各サーバの過負荷状態となっている期間を出力できるようにしたメソッド`find_overload(filename, N: int, m: int, t: int)`を作成した。求められる機能を実現するための手順は以下の通りである。

1. 一つのサーバのタイムアウトを除く直近m回までの応答時間と確認日時を記録する。実行回数がm回に満たない場合記録だけを行う。
2. 平均応答時間がtを上回った場合にm回前の確認日時を記録する。
3. 過負荷状態が終わった(直近m回までの平均応答時間がtを下回った)時に、そのIPv4アドレスおよび2で記録した確認日時と現在参照している確認日時の差分を`＜サーバアドレス＞,＜過負荷状態の時間(秒)＞,,＜故障時刻(YYYY-MM-DD hh:mm:ss)＞,＜復旧時刻(YYYY-MM-DD hh:mm:ss)＞`のフォーマットで出力する。

テスト用データlog3.csvは以下の通りである。
そして、`find_overload("log3.csv", 1, 3, 100)`で実行したときの結果は、
```
192.168.1.2/24,180,2020-10-19 13:30:35,2020-10-19 13:33:35
10.20.30.1/16,300,2020-10-19 13:30:24,2020-10-19 13:35:24
192.168.1.2/24,180,2020-10-19 13:33:35,2020-10-19 13:36:35
192.168.1.1/24,240,2020-10-19 13:33:34,2020-10-19 13:37:34
```
のようになった。
```
20201019133024,10.20.30.1/16,1
20201019133025,10.20.30.2/16,90
20201019133034,192.168.1.1/24,43
20201019133035,192.168.1.2/24,150
20201019133124,10.20.30.1/16,2
20201019133125,10.20.30.2/16,1
20201019133134,192.168.1.1/24,10
20201019133135,192.168.1.2/24,90
20201019133224,10.20.30.1/16,522
20201019133225,10.20.30.2/16,1
20201019133234,192.168.1.1/24,8
20201019133235,192.168.1.2/24,100
20201019133324,10.20.30.1/16,90
20201019133325,10.20.30.2/16,2
20201019133334,192.168.1.1/24,111
20201019133335,192.168.1.2/24,80
20201019133424,10.20.30.1/16,88
20201019133425,10.20.30.2/16,2
20201019133434,192.168.1.1/24,123
20201019133435,192.168.1.2/24,120
20201019133524,10.20.30.1/16,50
20201019133525,10.20.30.2/16,2
20201019133534,192.168.1.1/24,-
20201019133535,192.168.1.2/24,110
20201019133624,10.20.30.1/16,21
20201019133625,10.20.30.2/16,2
20201019133634,192.168.1.1/24,98
20201019133635,192.168.1.2/24,15
20201019133724,10.20.30.1/16,1
20201019133725,10.20.30.2/16,90
20201019133734,192.168.1.1/24,20
20201019133735,192.168.1.2/24,10
```
## 設問4

ネットワーク経路にあるスイッチに障害が発生した場合、そのスイッチの配下にあるサーバの応答がすべてタイムアウトすると想定される。そこで、あるサブネット内のサーバが全て故障（ping応答がすべてN回以上連続でタイムアウト）している場合は、そのサブネット（のスイッチ）の故障とみなせる。
<br>
設問2のメソッド`find_timed_out_ip_N(filename, N: int)`を拡張して、各サブネット毎にネットワークの故障期間を出力できるようにしたメソッド`find_timed_out_ip_subnet(filename, N: int)`を作成した。求められる機能を実現するための手順は以下の通りである。

1. 後に行う確認のために、サブネットを表すネットワークプレフィックスごとのIPアドレスの一覧を作成する。
2. アドレスを記録するリストに連続でタイムアウトした回数が加えられていて、2回目以降のタイムアウトで加算される。
3. タイムアウトしていないかつ連続タイムアウト回数がN回を超えたとき、その故障期間、故障時刻、復旧時刻、ipアドレス、サブネットを記録する。
4. その時、故障期間が同じかつ前後の故障時刻、復旧時刻の差分が1分以内であれば同時刻の故障とみなし、ipアドレスをその故障記録に加える。
5. csvの参照が終わったあとに、1.で作った一覧を使いIPアドレスに過不足がないことを確認しながらサブネットの故障記録を`＜ネットワークプレフィックス＞,＜故障期間(秒)＞,＜故障時刻(YYYY-MM-DD hh:mm:ss)＞,＜復旧時刻(YYYY-MM-DD hh:mm:ss)＞`のフォーマットで出力する。


テスト用データlog4.csvは以下の通りである。
そして、`find_overload("log3.csv", 1, 3, 100)`で実行したときの結果は、
```
16,180,2020-10-19 13:33:24,2020-10-19 13:30:24
16,180,2020-10-19 13:37:24,2020-10-19 13:34:24
24,240,2020-10-19 13:38:34,2020-10-19 13:34:34
```
のようになった。
```20201019133024,10.20.30.1/16,-
20201019133025,10.20.30.2/16,-
20201019133034,192.168.1.1/24,-
20201019133035,192.168.1.2/24,150
20201019133124,10.20.30.1/16,-
20201019133125,10.20.30.2/16,-
20201019133134,192.168.1.1/24,-
20201019133135,192.168.1.2/24,90
20201019133224,10.20.30.1/16,-
20201019133225,10.20.30.2/16,-
20201019133234,192.168.1.1/24,-
20201019133235,192.168.1.2/24,100
20201019133324,10.20.30.1/16,90
20201019133325,10.20.30.2/16,2
20201019133334,192.168.1.1/24,111
20201019133335,192.168.1.2/24,80
20201019133424,10.20.30.1/16,-
20201019133425,10.20.30.2/16,-
20201019133434,192.168.1.1/24,-
20201019133435,192.168.1.2/24,-
20201019133524,10.20.30.1/16,-
20201019133525,10.20.30.2/16,-
20201019133534,192.168.1.1/24,-
20201019133535,192.168.1.2/24,-
20201019133624,10.20.30.1/16,-
20201019133625,10.20.30.2/16,-
20201019133634,192.168.1.1/24,-
20201019133635,192.168.1.2/24,-
20201019133724,10.20.30.1/16,1
20201019133725,10.20.30.2/16,90
20201019133734,192.168.1.1/24,-
20201019133735,192.168.1.2/24,-
20201019133824,10.20.30.1/16,1
20201019133825,10.20.30.2/16,60
20201019133834,192.168.1.1/24,4
20201019133835,192.168.1.2/24,5```
